// Inside troop loop, replace tower attack logic with:

if (!troop.isFighting) {
  // Check distance to enemy tower
  let towerTarget = troop.isEnemy ? towerLeft : towerRight;
  let towerHealth = troop.isEnemy ? towerLeftHealth : towerRightHealth;

  // Position of troop center
  const troopPos = { x: troop.x + troop.el.offsetWidth / 2, y: troop.y + troop.el.offsetHeight / 2 };
  // Position of tower center
  const towerPos = { x: towerTarget.offsetLeft + towerTarget.offsetWidth / 2, y: towerTarget.offsetTop + towerTarget.offsetHeight / 2 };

  const distToTower = distance(troopPos, towerPos);

  if (distToTower < troop.range) {
    // Stop moving and fight tower
    troop.isFighting = true;
    troop.fightTarget = 'tower';
    troop.lastAttack = troop.lastAttack || 0;
  }
}

// If fighting tower, attack with cooldown
if (troop.isFighting && troop.fightTarget === 'tower') {
  if (now - troop.lastAttack > troop.attackCooldown) {
    if (troop.isEnemy) {
      towerLeftHealth -= troop.damage;
      if (towerLeftHealth < 0) towerLeftHealth = 0;
      towerLeftHealthBar.style.width = (towerLeftHealth / TOWER_MAX_HEALTH) * 100 + '%';
      if (towerLeftHealth <= 0) {
        alert("You lose! Your tower was destroyed.");
        window.location.reload();
      }
    } else {
      towerRightHealth -= troop.damage;
      if (towerRightHealth < 0) towerRightHealth = 0;
      towerRightHealthBar.style.width = (towerRightHealth / TOWER_MAX_HEALTH) * 100 + '%';
      if (towerRightHealth <= 0) {
        alert("You win! Enemy tower destroyed.");
        window.location.reload();
      }
    }
    troop.lastAttack = now;
  }
} else if (!troop.isFighting) {
  // Normal movement code here
  troop.x += troop.speed;
  troop.el.style.left = troop.x + 'px';
}
